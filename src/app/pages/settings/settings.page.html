<ion-header class="app-header">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button routerLink="/home" fill="clear">
        <ion-icon name="arrow-back-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title class="app-title">Settings</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="settings-screen" fullscreen>
  <!-- Floating decor -->
  <div class="floating-circles">
    <div class="floating-circle circle-1"></div>
    <div class="floating-circle circle-2"></div>
    <div class="floating-circle circle-3"></div>
  </div>
  <div class="floating-elements">
    <div class="floating-emoji emoji-1">üß†</div>
    <div class="floating-emoji emoji-2">üí≠</div>
    <div class="floating-emoji emoji-3">‚ù§Ô∏è</div>
    <div class="floating-emoji emoji-4">üåü</div>
  </div>

  <div class="settings-container">
    <!-- Profile Card -->
    <div class="glass-card profile-card">
      <div class="profile-header" style="align-items:center;">
        <!-- Gradient ring wrapper to match Home avatar border (no SCSS changes) -->
        <div
          (click)="openPhotoSheet()"
          title="Change profile picture"
          aria-label="Change profile picture"
          style="
            width:78px;height:78px;border-radius:50%;padding:3px;cursor:pointer;
            background:linear-gradient(135deg,#667eea 0%,#764ba2 50%,#f093fb 100%);
            box-shadow:0 8px 22px rgba(0,0,0,.25);flex:0 0 auto;display:flex;align-items:center;justify-content:center;">
          <ion-avatar
            class="profile-icon"
            style="width:72px;height:72px;border-radius:50%;overflow:hidden;background:#ffffff;">
            <img
              [src]="userData.photo"
              alt="Profile"
              style="width:100%;height:100%;object-fit:cover;display:block;" />
          </ion-avatar>
        </div>

        <div class="profile-info" style="width:100%; margin-left:12px;">
          <!-- NAME row -->
          <div class="field-row" style="display:flex; align-items:center; gap:6px; font-size:20px; margin-top:8px;">
            <!-- VIEW -->
            <ng-container *ngIf="!isEditingName; else nameEdit">
              <div
                class="profile-name"
                style="flex:1; min-width:0; line-height:1.2; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; cursor:pointer;"
                (click)="beginNameEdit()"
                role="button"
                tabindex="0"
                aria-label="Edit name"
                title="Tap to edit name">
                {{ userData.name || 'Tap to add your name' }}
              </div>
              <ion-button fill="clear" size="small" (click)="beginNameEdit()" aria-label="Edit name">
                <ion-icon name="create-outline"></ion-icon>
              </ion-button>
            </ng-container>

            <!-- EDIT -->
            <ng-template #nameEdit>
              <div style="flex:1; min-width:0;">
                <ion-input
                  [(ngModel)]="nameDraft"
                  name="nameDraft"
                  placeholder="Enter name"
                  [autofocus]="true"
                  (keydown.enter)="saveName()"
                  (keydown.escape)="cancelNameEdit()">
                </ion-input>
              </div>
              <ion-button fill="clear" size="small" (click)="saveName()" aria-label="Save name">
                <ion-icon name="checkmark-outline"></ion-icon>
              </ion-button>
              <ion-button fill="clear" size="small" (click)="cancelNameEdit()" aria-label="Cancel name edit">
                <ion-icon name="close-outline"></ion-icon>
              </ion-button>
            </ng-template>
          </div>

          <!-- EMAIL row -->
          <div class="field-row" style="display:flex; align-items:center; gap:6px; margin-top:-8px;">
            <!-- VIEW -->
            <ng-container *ngIf="!isEditingEmail; else emailEdit">
              <div
                class="profile-email"
                style="flex:1; min-width:0; line-height:1.2; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; cursor:pointer;"
                (click)="beginEmailEdit()"
                role="button"
                tabindex="0"
                aria-label="Edit email"
                title="Tap to edit email">
                {{ userData.email || 'Tap to add your email' }}
              </div>
              <ion-button fill="clear" size="small" (click)="beginEmailEdit()" aria-label="Edit email">
                <ion-icon name="create-outline"></ion-icon>
              </ion-button>
            </ng-container>

            <!-- EDIT -->
            <ng-template #emailEdit>
              <div style="flex:1; min-width:0;">
                <ion-input
                  [(ngModel)]="emailDraft"
                  name="emailDraft"
                  type="email"
                  placeholder="Enter email"
                  [autofocus]="true"
                  (keydown.enter)="saveEmail()"
                  (keydown.escape)="cancelEmailEdit()">
                </ion-input>
              </div>
              <ion-button fill="clear" size="small" (click)="saveEmail()" aria-label="Save email">
                <ion-icon name="checkmark-outline"></ion-icon>
              </ion-button>
              <ion-button fill="clear" size="small" (click)="cancelEmailEdit()" aria-label="Cancel email edit">
                <ion-icon name="close-outline"></ion-icon>
              </ion-button>
            </ng-template>
          </div>
        </div>
      </div>

      <!-- Hidden inputs for camera/gallery -->
      <input
        #cameraInput
        type="file"
        accept="image/*"
        capture="environment"
        (change)="onPhotoPicked($event, 'camera')"
        style="display:none" />
      <input
        #galleryInput
        type="file"
        accept="image/*"
        (change)="onPhotoPicked($event, 'gallery')"
        style="display:none" />
    </div>

    <!-- Caregiver Password (Patient Mode) -->
    <div class="glass-card pin-card">
      <div class="card-head">
        <div class="title-wrap">
          <ion-icon name="lock-closed-outline"></ion-icon>
          <h3>Caregiver Password (Patient Mode)</h3>
        </div>
        <ion-badge [color]="hasPin ? 'success' : 'medium'">
          {{ hasPin ? 'Active' : 'Not Set' }}
        </ion-badge>
      </div>

      <div class="pin-status" *ngIf="hasPin">
        <span class="label">Current password:</span>
        <span class="dots">{{ showMasked ? maskedPin : revealedPin }}</span>
        <ion-button fill="clear" size="small" (click)="toggleMask()" aria-label="Toggle password visibility">
          <ion-icon [name]="showMasked ? 'eye-outline' : 'eye-off-outline'"></ion-icon>
        </ion-button>
      </div>

      <form (ngSubmit)="savePin()" #pinForm="ngForm" novalidate>
        <!-- Require current password only if one exists -->
        <ion-item lines="full" *ngIf="hasPin">
          <ion-label position="stacked">Current Password</ion-label>
          <ion-input
            [type]="showCurrent ? 'text' : 'password'"
            [(ngModel)]="form.currentPin"
            name="currentPin"
            placeholder="Enter current password"
            required>
          </ion-input>
          <ion-button fill="clear" slot="end" size="small" type="button" (click)="showCurrent = !showCurrent">
            <ion-icon [name]="showCurrent ? 'eye-off-outline' : 'eye-outline'"></ion-icon>
          </ion-button>
        </ion-item>

        <ion-item lines="full">
          <ion-label position="stacked">New Password</ion-label>
          <ion-input
            [type]="showNew ? 'text' : 'password'"
            [(ngModel)]="form.newPin"
            name="newPin"
            placeholder="Enter new password (4‚Äì32 characters)"
            minlength="4"
            maxlength="32"
            required>
          </ion-input>
          <ion-button fill="clear" slot="end" size="small" type="button" (click)="showNew = !showNew">
            <ion-icon [name]="showNew ? 'eye-off-outline' : 'eye-outline'"></ion-icon>
          </ion-button>
        </ion-item>

        <ion-item lines="none">
          <ion-label position="stacked">Confirm New Password</ion-label>
          <ion-input
            [type]="showConfirm ? 'text' : 'password'"
            [(ngModel)]="form.confirmPin"
            name="confirmPin"
            placeholder="Re-enter new password"
            minlength="4"
            maxlength="32"
            required>
          </ion-input>
          <ion-button fill="clear" slot="end" size="small" type="button" (click)="showConfirm = !showConfirm">
            <ion-icon [name]="showConfirm ? 'eye-off-outline' : 'eye-outline'"></ion-icon>
          </ion-button>
        </ion-item>

        <div class="actions">
          <ion-button expand="block" type="submit" [disabled]="saving">
            <ion-icon name="save-outline" slot="start"></ion-icon>
            {{ hasPin ? 'Update Password' : 'Set Password' }}
          </ion-button>

          <ion-button
            expand="block"
            fill="outline"
            color="danger"
            (click)="promptRemovePin()"
            *ngIf="hasPin"
            [disabled]="saving"
            type="button">
            <ion-icon name="trash-outline" slot="start"></ion-icon>
            Remove Password
          </ion-button>
        </div>
      </form>

      <ion-note class="hint">
        This password is required to exit Patient Mode. You can use letters, numbers, or symbols (4‚Äì32 characters).
      </ion-note>
    </div>

    <!-- QR Code Card -->
    <div class="glass-card">
      <div class="card-head">
        <div class="title-wrap">
          <ion-icon name="qr-code-outline"></ion-icon>
          <h3>Patient QR Code</h3>
        </div>
        <ion-note>Share your profile with caregivers</ion-note>
      </div>

      <ion-button expand="block" fill="outline" (click)="toggleQRCode()">
        <ion-icon name="qr-code-outline" slot="start"></ion-icon>
        {{ showQRCode ? 'Hide QR Code' : 'Show QR Code' }}
      </ion-button>

      <div *ngIf="showQRCode" class="qr-display">
        <div class="qr-container" *ngIf="qrCodeImage; else qrPlaceholder">
          <img [src]="qrCodeImage" alt="Patient QR Code" class="qr-image" />
          <p class="qr-description">Scan this code to access patient profile</p>

          <!-- Unique Security Code (single line, scrolls horizontally if long) -->
          <div class="qr-security"
               style="display:flex;align-items:center;gap:8px;justify-content:center;margin-top:6px;flex-wrap:nowrap;min-width:0;">
            <strong style="flex:0 0 auto;font-weight:800;">Security Code:</strong>
            <code class="sec-code"
                  style="flex:1 1 auto;min-width:0;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;
                         font-weight:800;white-space:nowrap;overflow-x:auto;overflow-y:hidden;display:block;scrollbar-width:none;-ms-overflow-style:none;">
              {{ securityCode }}
            </code>
            <ion-button fill="clear" size="small" (click)="copySecurityCode()" aria-label="Copy security code">
              <ion-icon name="copy-outline"></ion-icon>
            </ion-button>
          </div>

          <small class="qr-data">{{ qrCodeData }}</small>
        </div>
        <ng-template #qrPlaceholder>
          <div class="qr-placeholder">
            <ion-icon name="qr-code-outline"></ion-icon>
            <p>Generating QR Code...</p>
          </div>
        </ng-template>
      </div>
    </div>

    <!-- Add Trusted Contact -->
    <div class="glass-card">
      <div class="card-head">
        <div class="title-wrap">
          <ion-icon name="people-outline"></ion-icon>
          <h3>Add Trusted Contact</h3>
        </div>
        <ion-note>Connect with caregivers</ion-note>
      </div>

      <div class="trusted-contact-options">
        <ion-button expand="block" fill="outline" (click)="scanQRCode()" [disabled]="isScanning">
          <ion-icon name="qr-code-outline" slot="start"></ion-icon>
          {{ isScanning ? 'Scanning...' : 'Scan QR Code' }}
        </ion-button>

        <div class="divider-text">
          <span>OR</span>
        </div>

        <form (ngSubmit)="addContactByCode()" #contactForm="ngForm">
          <ion-item lines="full">
            <ion-label position="stacked">Security Code</ion-label>
            <ion-input
              [(ngModel)]="contactSecurityCode"
              name="contactSecurityCode"
              placeholder="Enter security code"
              required>
            </ion-input>
          </ion-item>

          <ion-button expand="block" type="submit" [disabled]="!contactSecurityCode || isAddingContact">
            <ion-icon name="person-add-outline" slot="start"></ion-icon>
            {{ isAddingContact ? 'Adding...' : 'Add Contact' }}
          </ion-button>
        </form>
      </div>

      <!-- Trusted Contacts List -->
      <div class="trusted-contacts-list" *ngIf="trustedContacts.length > 0">
        <h4>Trusted Contacts</h4>
        <ion-list>
          <ion-item *ngFor="let contact of trustedContacts">
            <ion-avatar slot="start">
              <div class="family-avatar">
                <ion-icon name="people"></ion-icon>
              </div>
            </ion-avatar>
            <ion-label>
              <h3 class="family-name">{{ contact.name }}</h3>
              <p class="family-code">Security Code: {{ contact.securityCode }}</p>
              <p class="contact-added">Added {{ formatDate(contact.addedAt) }}</p>
            </ion-label>
            <ion-button fill="clear" slot="end" color="danger" (click)="removeContact(contact.id)">
              <ion-icon name="trash-outline"></ion-icon>
            </ion-button>
          </ion-item>
        </ion-list>
      </div>
    </div>

    <!-- More Options -->
    <div class="glass-card">
      <div class="card-head">
        <div class="title-wrap">
          <ion-icon name="settings-outline"></ion-icon>
          <h3>More Options</h3>
        </div>
      </div>

      <ion-list lines="full">
        <ion-item button (click)="clearAllData()">
          <ion-icon name="trash-outline" slot="start" color="warning"></ion-icon>
          <ion-label>
            <h3>Clear All Data</h3>
            <p>Remove all game progress</p>
          </ion-label>
        </ion-item>

        <ion-item button (click)="logout()">
          <ion-icon name="log-out-outline" slot="start" color="danger"></ion-icon>
          <ion-label>
            <h3>Logout</h3>
            <p>Sign out of your account</p>
          </ion-label>
        </ion-item>
      </ion-list>
    </div>
  </div>
</ion-content>

